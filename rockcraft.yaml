name: canonicalwebteam-juju-logger
base: "ubuntu@22.04"
version: latest
summary: A service to collect and log Juju model data.
description: |
  This package sets up a service that collects data from Juju models and logs it for analysis and monitoring purposes.
license: LGPL-3.0
platforms:
  amd64:

package-repositories:
  - type: apt
    url: https://apt.grafana.com
    key-id: B53AE77BADB630A683046005963FA27710458545
    suites:
      - stable
    components:
      - main

parts:
  flask-app:
    plugin: python
    source: .
    python-requirements:
      - requirements.txt
    build-packages:
      - python3-dev
      - python3-pip
      - python3-venv
    stage-packages:
      - python3
  alloy:
    plugin: nil
    stage-packages:
      - alloy
    after:
      - flask-app

# Services to be loaded by the Pebble entrypoint
services:
  flask-app:
    override: replace
    startup: enabled
    command: flask run --host=0.0.0.0 --port=8000
    environment:
      TZ: UTC
      FLASK_APP: app.py
    on-failure: shutdown
  alloy-service:
    override: replace
    startup: enabled
    command: alloy run /etc/alloy/config.alloy
    environment:
      TZ: UTC
    after:
      - flask-app
